##! CVE-2021-26855
##! Developed for LÃ©argas by Patrick Kelley
##! 2019-04-03
##! www.leargassecurity.com

##! Identifier="2019-04-03"
##! Iteration="1.2"
##! Description="CVE-2021-26855"
##! Protocol="HTTP"
##! CreationDate="2019-04-03"
##! LastUpdate="2019-04-03"

@load base/protocols/http
@load base/frameworks/notice


export {
    redef enum Notice::Type += {
        HTTP::CVE_2021_26855,
    };

		# Regular expression to match OWA Post
    global BadOWAPost = /[l][o][g][o][n][.][c][s][s]/
		 				|/[o][w][a][f][o][t][_][j][a]/
						|/[d][h][c][p][v][6][l][g][n][b][o][t][l]/
						|/[d][h][c][p][v][6][o][w][a][f][o][n][t]/
						|/[d][h][c][p][v][6][S][e][g][o][e][U][I]/
						|/[d][h][c][p][v][6][l][g][n][b][o][t][l]/
						&redef;

		global WebShells =	/web\.aspx/
							|/help\.aspx/
							|/document\.aspx/
							|/errorEE\.aspx/
							|/errorEEE\.aspx/
							|/errorEW\.aspx/
							|/errorFF\.aspx/
							|/healthcheck\.aspx/
							|/aspnet_www\aspx/
							|/aspnet_client\.aspx/
							|/xx\.aspx/
							|/shell\.aspx/
							|/aspnet_iisstart\.aspx/
							|/one\.aspx/
							&redef;
							
event http_request(c: connection, method: string, original_URI: string, unescaped_URI: string, version: string) &priority=3
		{
			if ( method == "POST" && ( BadOWAPost in unescaped_URI))
		{
		NOTICE([$note=HTTP::CVE_2021_26855,
		$conn=c,
		$msg=fmt("%s attempted to POST malicious data to - %s.", c$id$orig_h, c$id$resp_h),
		$identifier=cat(c$id$orig_h),
		$sub=fmt("Severity: 1"),
		$suppress_for=1hr]);
		}
	}

	
event http_request(c: connection, method: string, original_URI: string, unescaped_URI: string, version: string) &priority=3
		{
			if ( WebShells in unescaped_URI)
		{
		NOTICE([$note=HTTP::CVE_2021_26855,
		$conn=c,
		$msg=fmt("%s attempted to connect to a present webshell on - %s.", c$id$orig_h, c$id$resp_h),
		$identifier=cat(c$id$orig_h),
		$sub=fmt("Severity: 1"),
		$suppress_for=1hr]);
		}
	}
}
